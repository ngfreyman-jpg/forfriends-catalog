<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ForFriends — Admin</title>

  <!-- (необязательно) фавикон, чтобы не было 404 в консоли -->
  <link rel="icon" href="../favicon.ico" />

  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; }
    body {
      display: grid;
      place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: #0f1115; color: #e6e6e6;
    }
    .splash {
      display: grid; gap: 12px; place-items: center;
      opacity: .9;
    }
    .splash .logo {
      font-weight: 800; font-size: 42px; letter-spacing: .5px;
    }
    .splash small { opacity: .65 }
    /* когда CMS смонтировалась, скрываем заставку */
    body.cms-loaded .splash { display: none; }
  </style>
</head>
<body>
  <!-- Заставка до инициализации CMS -->
  <div class="splash">
    <div class="logo">Decap</div>
    <small>Загрузка панели управления…</small>
  </div>

  <noscript>Для работы админки нужен включённый JavaScript.</noscript>

  <!-- Decap CMS (админка) -->
  <script src="https://unpkg.com/decap-cms@3.8.4/dist/decap-cms.js"></script>

  <script>
    /**
     * ВАРИАНТ B — «надёжный» ловец токена:
     * 1) Сохраняем токен из URL фрагмента (#access_token=... или authorization=github:success:...)
     * 2) Сохраняем токен из postMessage от попапа
     * После сохранения — обновляем страницу, чтобы CMS «увидела» токен.
     */

    (function () {
      function saveTokenAndReload(token) {
        if (!token) return;
        try {
          localStorage.setItem('decap-cms-user', JSON.stringify({ token: token, provider: 'github' }));
          location.replace(location.href.split('#')[0]); // убрать хэш и перегрузить
        } catch (e) {
          console.error('Cannot save decap token:', e);
        }
      }

      // 1) Токен в хэше URL
      (function catchTokenFromHash() {
        var hash = location.hash || "";
        if (!hash) return;

        // #access_token=...&token_type=...
        var m1 = hash.match(/(?:^|[#&])access_token=([^&]+)/i);
        if (m1 && m1[1]) {
          var token = decodeURIComponent(m1[1]);
          saveTokenAndReload(token);
          return;
        }

        // #authorization=github:success:gho_xxx...
        var m2 = hash.match(/authorization=github:success:([^&]+)/i);
        if (m2 && m2[1]) {
          saveTokenAndReload(decodeURIComponent(m2[1]));
          return;
        }
      })();

      // 2) Токен из postMessage (попап)
      window.addEventListener('message', function (e) {
        if (typeof e.data !== 'string') return;

        // формат: "authorization:github:success:gho_xxx..."
        if (e.data.startsWith('authorization:github:success:')) {
          var token = e.data.split(':').pop().trim();
          saveTokenAndReload(token);
        }

        // резерв: некоторые провайдеры посылают объект {token, provider}
        try {
          var obj = null;
          if (e.data[0] === '{') obj = JSON.parse(e.data);
          if (obj && obj.token && (obj.provider === 'github' || !obj.provider)) {
            saveTokenAndReload(obj.token);
          }
        } catch (_) {}
      }, false);
    })();

    /**
     * Инициализация CMS (используем config.yml рядом с этим файлом).
     * Decap сам подхватит /admin/config.yml, но явно дернуть тоже ок.
     */
    document.addEventListener('DOMContentLoaded', function () {
      if (window.CMS && typeof window.CMS.init === 'function') {
        window.CMS.init(); // load_config_file: true по умолчанию
        // Помечаем, что CMS смонтировалась — скрываем заставку:
        // Небольшая задержка, чтобы гарантированно успело смонтироваться.
        setTimeout(function(){ document.body.classList.add('cms-loaded'); }, 600);
      }
    });
  </script>
</body>
</html>
